<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ ë ˆì¹´ ì„œë²„ ê¸°ë°˜ MSA í†µí•© í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background-color: #48bb78; }
        .status-offline { background-color: #f56565; }
        .status-unknown { background-color: #ed8936; }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4fd1c7 0%, #38b2ac 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
        }

        .log-area {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .service-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .service-card.online {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .service-card.offline {
            border-left-color: #f56565;
            background: #fed7d7;
        }

        .service-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .service-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .service-details {
            font-size: 0.9em;
            color: #666;
        }

        .eureka-status {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .api-test-section {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .success {
            color: #48bb78;
            background-color: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .error {
            color: #f56565;
            background-color: #fed7d7;
            border: 1px solid #feb2b2;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .info {
            color: #667eea;
            background-color: #ebf4ff;
            border: 1px solid #bee3f8;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }

            .service-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ ìœ ë ˆì¹´ ì„œë²„ ê¸°ë°˜ MSA í†µí•© í…ŒìŠ¤íŠ¸</h1>
            <p>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ì „ì²´ í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”</p>
        </div>

        <!-- ìœ ë ˆì¹´ ì„œë²„ ìƒíƒœ -->
        <div class="card">
            <h3>ğŸ¢ ìœ ë ˆì¹´ ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒíƒœ</h3>
            <div class="eureka-status">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span class="status-indicator status-unknown" id="eureka-status"></span>
                        <strong>Eureka Server (8761)</strong>
                        <span id="eureka-status-text">í™•ì¸ ì¤‘...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="openEurekaUI()">ìœ ë ˆì¹´ UI ì—´ê¸°</button>
                </div>
                <div id="registered-services" style="margin-top: 15px;">
                    <h4>ë“±ë¡ëœ ì„œë¹„ìŠ¤ ëª©ë¡</h4>
                    <div class="service-grid" id="service-list"></div>
                </div>
            </div>
            <button class="btn" onclick="checkEurekaServices()">ğŸ”„ ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-success" onclick="startMSATest()">ğŸš€ MSA í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
        </div>

        <div class="dashboard">
            <!-- API Gateway ìƒíƒœ -->
            <div class="card">
                <h3>ğŸšª API Gateway ìƒíƒœ</h3>
                <div style="margin-bottom: 15px;">
                    <div>
                        <span class="status-indicator status-unknown" id="gateway-status"></span>
                        <strong>API Gateway (8080)</strong>
                        <span id="gateway-status-text">í™•ì¸ ì¤‘...</span>
                    </div>
                </div>
                <div id="gateway-routes" style="margin-top: 15px;">
                    <h4>Gateway ë¼ìš°íŠ¸ ì •ë³´</h4>
                    <div id="routes-list"></div>
                </div>
                <button class="btn" onclick="checkGatewayHealth()">ìƒíƒœ í™•ì¸</button>
                <button class="btn btn-secondary" onclick="viewGatewayRoutes()">ë¼ìš°íŠ¸ ì¡°íšŒ</button>
            </div>

            <!-- Auth0 ì¸ì¦ -->
            <div class="card">
                <h3>ğŸ” Auth0 ì¸ì¦</h3>
                <div id="auth-status" class="info">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                <button class="btn" onclick="loginWithAuth0()" id="login-btn">Auth0 ë¡œê·¸ì¸</button>
                <button class="btn btn-danger" onclick="logout()" id="logout-btn" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
                
                <div id="user-info" style="display: none;">
                    <h4>í˜„ì¬ ì‚¬ìš©ì</h4>
                    <div id="user-details"></div>
                </div>
            </div>

            <!-- ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ -->
            <div class="card">
                <h3>ğŸ”§ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ API í…ŒìŠ¤íŠ¸</h3>
                <div class="api-test-section">
                    <div class="form-group">
                        <label>í…ŒìŠ¤íŠ¸í•  ì„œë¹„ìŠ¤ ì„ íƒ</label>
                        <select id="service-select">
                            <option value="">ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="USER-SERVICE">ì‚¬ìš©ì ì„œë¹„ìŠ¤</option>
                            <option value="BE-APIManagementService">API ê´€ë¦¬ ì„œë¹„ìŠ¤</option>
                            <option value="BE-CustomAPIManagementService">ì»¤ìŠ¤í…€ API ê´€ë¦¬ ì„œë¹„ìŠ¤</option>
                            <option value="BE-AIFeatureService">AI ê¸°ëŠ¥ ì„œë¹„ìŠ¤</option>
                            <option value="BE-SystemManagementService">ì‹œìŠ¤í…œ ê´€ë¦¬ ì„œë¹„ìŠ¤</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>API ì—”ë“œí¬ì¸íŠ¸</label>
                        <input type="text" id="api-endpoint" placeholder="/api/users" value="/actuator/health">
                    </div>
                    <div class="form-group">
                        <label>HTTP ë©”ì„œë“œ</label>
                        <select id="http-method">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <button class="btn" onclick="testMicroservice()" id="test-api-btn" disabled>API í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                    <button class="btn btn-secondary" onclick="loadTestScenarios()">ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸</button>
                </div>
                
                <div id="api-result"></div>
            </div>

            <!-- ì„œí‚· ë¸Œë ˆì´ì»¤ ëª¨ë‹ˆí„°ë§ -->
            <div class="card">
                <h3>âš¡ ì„œí‚· ë¸Œë ˆì´ì»¤ ëª¨ë‹ˆí„°ë§</h3>
                <div id="circuit-breaker-status">
                    <p>ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
                </div>
                <button class="btn" onclick="checkCircuitBreakers()">ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ í™•ì¸</button>
                <button class="btn btn-secondary" onclick="simulateFailure()">ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜</button>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
        <div class="card">
            <h3>ğŸ“‹ ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ë¡œê·¸</h3>
            <button class="btn btn-secondary" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <button class="btn btn-secondary" onclick="exportLogs()">ë¡œê·¸ ë‚´ë³´ë‚´ê¸°</button>
            <div id="log-area" class="log-area"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let authToken = null;
        let eurekaServices = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ ìœ ë ˆì¹´ ì„œë²„ ê¸°ë°˜ MSA í†µí•© í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // URL íŒŒë¼ë¯¸í„° í™•ì¸ (Auth0 ì½œë°± ë“±)
            handleAuth0Callback();
            
            // ì´ˆê¸° ìƒíƒœ í™•ì¸
            setTimeout(() => {
                checkEurekaServices();
                checkGatewayHealth();
                checkCircuitBreakers();
            }, 100);
        });

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            const div = document.createElement('div');
            div.textContent = logEntry;
            div.style.color = type === 'error' ? '#f56565' : type === 'success' ? '#48bb78' : '#e2e8f0';
            
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-area').innerHTML = '';
        }

        function exportLogs() {
            const logArea = document.getElementById('log-area');
            const logs = logArea.innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'msa-test-logs-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            log('ğŸ“„ ë¡œê·¸ê°€ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
        }

        // ìœ ë ˆì¹´ ì„œë¹„ìŠ¤ í™•ì¸
        async function checkEurekaServices() {
            log('ğŸ¢ ìœ ë ˆì¹´ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...');
            
            try {
                // ìœ ë ˆì¹´ ì„œë²„ ìƒíƒœ í™•ì¸
                const eurekaResponse = await fetch('http://localhost:8761/actuator/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (eurekaResponse.ok) {
                    document.getElementById('eureka-status').className = 'status-indicator status-online';
                    document.getElementById('eureka-status-text').textContent = 'Online';
                    log('âœ… ìœ ë ˆì¹´ ì„œë²„ (8761) ì—°ê²° ì„±ê³µ');
                    
                    // ë“±ë¡ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    await fetchRegisteredServices();
                } else {
                    throw new Error('Eureka health check failed');
                }
            } catch (error) {
                document.getElementById('eureka-status').className = 'status-indicator status-offline';
                document.getElementById('eureka-status-text').textContent = 'Offline';
                log('âŒ ìœ ë ˆì¹´ ì„œë²„ (8761) ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
                
                // ìœ ë ˆì¹´ ì—†ì´ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ë„ë¡ ê¸°ë³¸ ì„œë¹„ìŠ¤ ëª©ë¡ í‘œì‹œ
                showDefaultServices();
            }
        }

        // ë“±ë¡ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchRegisteredServices() {
            try {
                const response = await fetch('http://localhost:8761/eureka/apps', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    eurekaServices = data.applications?.application || [];
                    log(`ğŸ“‹ ìœ ë ˆì¹´ì—ì„œ ${eurekaServices.length}ê°œ ì„œë¹„ìŠ¤ ë°œê²¬`);
                    displayServices(eurekaServices);
                } else {
                    throw new Error('Failed to fetch services from Eureka');
                }
            } catch (error) {
                log('âš ï¸ ìœ ë ˆì¹´ì—ì„œ ì„œë¹„ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                showDefaultServices();
            }
        }

        // ì„œë¹„ìŠ¤ ëª©ë¡ í‘œì‹œ
        function displayServices(services) {
            const serviceList = document.getElementById('service-list');
            serviceList.innerHTML = '';
            
            if (services.length === 0) {
                serviceList.innerHTML = '<p>ë“±ë¡ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card online';
                
                const instances = service.instance ? (Array.isArray(service.instance) ? service.instance : [service.instance]) : [];
                const instanceCount = instances.length;
                const healthyInstances = instances.filter(inst => inst.status === 'UP').length;
                
                serviceCard.innerHTML = `
                    <div class="service-info">
                        <div class="service-name">${service.name}</div>
                        <div class="status-indicator status-${healthyInstances > 0 ? 'online' : 'offline'}"></div>
                    </div>
                    <div class="service-details">
                        ì¸ìŠ¤í„´ìŠ¤: ${healthyInstances}/${instanceCount} ì •ìƒ
                        ${instances.length > 0 ? `<br>í¬íŠ¸: ${instances[0].port?.$}` : ''}
                    </div>
                `;
                
                serviceList.appendChild(serviceCard);
            });
            
            // ì„œë¹„ìŠ¤ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
            updateServiceSelect(services);
        }

        // ê¸°ë³¸ ì„œë¹„ìŠ¤ ëª©ë¡ í‘œì‹œ (ìœ ë ˆì¹´ ì—†ì„ ë•Œ)
        function showDefaultServices() {
            const defaultServices = [
                { name: 'API-GATEWAY', status: 'unknown', port: '8080' },
                { name: 'USER-SERVICE', status: 'unknown', port: '8081' },
                { name: 'BE-APIManagementService', status: 'unknown', port: '8082' },
                { name: 'BE-CustomAPIManagementService', status: 'unknown', port: '8083' },
                { name: 'BE-AIFeatureService', status: 'unknown', port: '8084' },
                { name: 'BE-SystemManagementService', status: 'unknown', port: '8085' }
            ];
            
            const serviceList = document.getElementById('service-list');
            serviceList.innerHTML = '';
            
            defaultServices.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                
                serviceCard.innerHTML = `
                    <div class="service-info">
                        <div class="service-name">${service.name}</div>
                        <div class="status-indicator status-${service.status}"></div>
                    </div>
                    <div class="service-details">
                        í¬íŠ¸: ${service.port} (ìœ ë ˆì¹´ ë¯¸ì—°ê²°)
                    </div>
                `;
                
                serviceList.appendChild(serviceCard);
            });
        }

        // ì„œë¹„ìŠ¤ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateServiceSelect(services) {
            const serviceSelect = document.getElementById('service-select');
            // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€í•˜ê³  ì‹¤ì œ ë“±ë¡ëœ ì„œë¹„ìŠ¤ë§Œ í™œì„±í™”
            // êµ¬í˜„ì´ ë³µì¡í•˜ë¯€ë¡œ ê¸°ë³¸ ì˜µì…˜ ìœ ì§€
        }

        // API Gateway ìƒíƒœ í™•ì¸
        async function checkGatewayHealth() {
            log('ğŸšª API Gateway ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...');
            
            try {
                const response = await fetch('http://localhost:8080/actuator/health');
                
                if (response.ok) {
                    document.getElementById('gateway-status').className = 'status-indicator status-online';
                    document.getElementById('gateway-status-text').textContent = 'Online';
                    log('âœ… API Gateway (8080) ì—°ê²° ì„±ê³µ');
                } else {
                    throw new Error('Gateway health check failed');
                }
            } catch (error) {
                document.getElementById('gateway-status').className = 'status-indicator status-offline';
                document.getElementById('gateway-status-text').textContent = 'Offline';
                log('âŒ API Gateway (8080) ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // Gateway ë¼ìš°íŠ¸ ì¡°íšŒ
        async function viewGatewayRoutes() {
            log('ğŸ” Gateway ë¼ìš°íŠ¸ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘...');
            
            try {
                const response = await fetch('http://localhost:8080/actuator/gateway/routes');
                
                if (response.ok) {
                    const routes = await response.json();
                    displayGatewayRoutes(routes);
                    log(`âœ… Gateway ë¼ìš°íŠ¸ ${routes.length}ê°œ ì¡°íšŒ ì™„ë£Œ`);
                } else {
                    throw new Error('Failed to fetch gateway routes');
                }
            } catch (error) {
                log('âŒ Gateway ë¼ìš°íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'error');
                document.getElementById('routes-list').innerHTML = '<div class="error">ë¼ìš°íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // Gateway ë¼ìš°íŠ¸ í‘œì‹œ
        function displayGatewayRoutes(routes) {
            const routesList = document.getElementById('routes-list');
            routesList.innerHTML = '';
            
            if (routes.length === 0) {
                routesList.innerHTML = '<p>ì„¤ì •ëœ ë¼ìš°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            routes.forEach(route => {
                const routeDiv = document.createElement('div');
                routeDiv.style.cssText = 'background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; font-size: 0.9em;';
                
                const predicates = route.predicates || [];
                const pathPredicate = predicates.find(p => p.name === 'Path');
                const path = pathPredicate ? pathPredicate.args.pattern : 'N/A';
                
                routeDiv.innerHTML = `
                    <strong>${route.route_id}</strong><br>
                    ê²½ë¡œ: ${path}<br>
                    ëŒ€ìƒ: ${route.uri}
                `;
                
                routesList.appendChild(routeDiv);
            });
        }

        // ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ í™•ì¸
        async function checkCircuitBreakers() {
            log('âš¡ ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...');
            
            try {
                const response = await fetch('http://localhost:8080/actuator/circuitbreakers');
                
                if (response.ok) {
                    const circuitBreakers = await response.json();
                    displayCircuitBreakers(circuitBreakers);
                    log('âœ… ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ ì¡°íšŒ ì™„ë£Œ');
                } else {
                    throw new Error('Failed to fetch circuit breakers');
                }
            } catch (error) {
                log('âŒ ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'error');
                document.getElementById('circuit-breaker-status').innerHTML = '<div class="error">ì„œí‚· ë¸Œë ˆì´ì»¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ í‘œì‹œ
        function displayCircuitBreakers(circuitBreakers) {
            const statusDiv = document.getElementById('circuit-breaker-status');
            statusDiv.innerHTML = '';
            
            if (!circuitBreakers.circuitBreakers || circuitBreakers.circuitBreakers.length === 0) {
                statusDiv.innerHTML = '<p>ì„¤ì •ëœ ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            circuitBreakers.circuitBreakers.forEach(cb => {
                const cbDiv = document.createElement('div');
                cbDiv.style.cssText = 'background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid ' + 
                    (cb.state === 'CLOSED' ? '#48bb78' : cb.state === 'OPEN' ? '#f56565' : '#ed8936') + ';';
                
                cbDiv.innerHTML = `
                    <strong>${cb.name}</strong><br>
                    ìƒíƒœ: <span style="color: ${cb.state === 'CLOSED' ? '#48bb78' : cb.state === 'OPEN' ? '#f56565' : '#ed8936'}">${cb.state}</span><br>
                    ì‹¤íŒ¨ìœ¨: ${cb.metrics?.failureRate || 0}%<br>
                    í˜¸ì¶œ ìˆ˜: ${cb.metrics?.numberOfCalls || 0}
                `;
                
                statusDiv.appendChild(cbDiv);
            });
        }

        // Auth0 ë¡œê·¸ì¸
        function loginWithAuth0() {
            log('ğŸ” Auth0 ë¡œê·¸ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
            window.location.href = 'http://localhost:8080/oauth2/authorization/auth0';
        }

        // Auth0 ì½œë°± ì²˜ë¦¬
        function handleAuth0Callback() {
            // URL ê²½ë¡œ í™•ì¸
            if (window.location.pathname === '/auth/login-success') {
                log('ğŸ” Auth0 ë¡œê·¸ì¸ ì„±ê³µ ê°ì§€!');
                fetchUserInfoFromSession();
            }
            
            // URL íŒŒë¼ë¯¸í„° í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                log('ğŸ” Auth0 ì¸ì¦ ì½”ë“œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.');
                fetchUserInfoFromSession();
            }
        }

        // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function fetchUserInfoFromSession() {
            try {
                const response = await fetch('http://localhost:8080/auth/user-info', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const userInfo = await response.json();
                    
                    if (userInfo.authenticated) {
                        currentUser = {
                            sub: userInfo.userId || userInfo.sub,
                            email: userInfo.email,
                            name: userInfo.name
                        };

                        log('âœ… ì‚¬ìš©ì ì¸ì¦ ì™„ë£Œ!', 'success');
                        updateAuthUI();
                        
                        // API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í™œì„±í™”
                        document.getElementById('test-api-btn').disabled = false;
                    }
                }
            } catch (error) {
                log('âŒ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì¸ì¦ UI ì—…ë°ì´íŠ¸
        function updateAuthUI() {
            document.getElementById('auth-status').className = 'success';
            document.getElementById('auth-status').textContent = `âœ… ë¡œê·¸ì¸ ì„±ê³µ: ${currentUser.email}`;
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'inline-block';
            
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('user-details').innerHTML = `
                <strong>ID:</strong> ${currentUser.sub}<br>
                <strong>Email:</strong> ${currentUser.email}<br>
                <strong>Name:</strong> ${currentUser.name || 'N/A'}
            `;
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            authToken = null;
            currentUser = null;
            
            document.getElementById('auth-status').className = 'info';
            document.getElementById('auth-status').textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
            document.getElementById('login-btn').style.display = 'inline-block';
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('test-api-btn').disabled = true;

            log('ğŸ”“ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
            window.location.href = 'http://localhost:8080/auth/logout';
        }

        // ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ API í…ŒìŠ¤íŠ¸
        async function testMicroservice() {
            const serviceSelect = document.getElementById('service-select');
            const apiEndpoint = document.getElementById('api-endpoint');
            const httpMethod = document.getElementById('http-method');
            
            if (!serviceSelect.value) {
                log('âŒ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            if (!apiEndpoint.value) {
                log('âŒ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            const serviceName = serviceSelect.value;
            let url;
            
            // URL êµ¬ì„± (ìœ ë ˆì¹´ ì„œë¹„ìŠ¤ ì´ë¦„ ê¸°ë°˜)
            if (serviceName === 'USER-SERVICE') {
                url = `http://localhost:8080/gateway/users${apiEndpoint.value}`;
            } else {
                // ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë“¤ì€ ì„œë¹„ìŠ¤ ì´ë¦„ì„ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ê²½ë¡œ êµ¬ì„±
                const servicePath = serviceName.toLowerCase().replace('be-', '').replace('service', '');
                url = `http://localhost:8080/gateway/${servicePath}${apiEndpoint.value}`;
            }

            log(`ğŸ”§ ${serviceName} API í…ŒìŠ¤íŠ¸ ì‹œì‘: ${httpMethod.value} ${url}`);

            try {
                const requestOptions = {
                    method: httpMethod.value,
                    credentials: 'include' // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
                };

                const response = await fetch(url, requestOptions);
                const responseText = await response.text();
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch {
                    responseData = responseText;
                }

                if (response.ok) {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="success">âœ… API í…ŒìŠ¤íŠ¸ ì„±ê³µ!<br>
                        <strong>ìƒíƒœ ì½”ë“œ:</strong> ${response.status}<br>
                        <strong>ì‘ë‹µ:</strong><br>
                        <pre>${JSON.stringify(responseData, null, 2)}</pre></div>`;
                    log(`âœ… ${serviceName} API í…ŒìŠ¤íŠ¸ ì„±ê³µ: ${response.status}`, 'success');
                } else if (response.status === 503) {
                    // ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ ì—´ë¦° ê²½ìš°
                    document.getElementById('api-result').innerHTML = 
                        `<div class="error">âš¡ ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ ì—´ë¦° ìƒíƒœì…ë‹ˆë‹¤<br>
                        <strong>ìƒíƒœ ì½”ë“œ:</strong> ${response.status}<br>
                        <strong>Fallback ì‘ë‹µ:</strong><br>
                        <pre>${JSON.stringify(responseData, null, 2)}</pre><br>
                        <button class="btn btn-secondary" onclick="resetCircuitBreaker('${serviceName}')">ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ ì‹œë„</button>
                        <button class="btn btn-secondary" onclick="testDirectConnection('${serviceName}', '${apiEndpoint.value}')">ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸</button></div>`;
                    log(`âš¡ ${serviceName} ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ ì—´ë¦° ìƒíƒœì…ë‹ˆë‹¤`, 'error');
                } else {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
            } catch (error) {
                document.getElementById('api-result').innerHTML = 
                    `<div class="error">âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨<br>
                    <strong>ì˜¤ë¥˜:</strong> ${error.message}</div>`;
                log(`âŒ ${serviceName} API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ ì‹œë„
        async function resetCircuitBreaker(serviceName) {
            log(`ğŸ”„ ${serviceName} ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ì„ ì‹œë„í•©ë‹ˆë‹¤...`);
            
            // ì—¬ëŸ¬ ë²ˆ ì—°ì†ìœ¼ë¡œ ìš”ì²­í•˜ì—¬ ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ ìœ ë„
            for (let i = 0; i < 3; i++) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1ì´ˆ ëŒ€ê¸°
                    const response = await fetch(`http://localhost:8080/gateway/users/actuator/health`, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        log(`âœ… ${serviceName} ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                        await testMicroservice(); // ë‹¤ì‹œ í…ŒìŠ¤íŠ¸
                        return;
                    }
                } catch (error) {
                    log(`âš ï¸ ë¦¬ì…‹ ì‹œë„ ${i + 1}/3 ì‹¤íŒ¨`, 'error');
                }
            }
            
            log(`âŒ ${serviceName} ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì‹œê°„ì„ ë‘ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`, 'error');
        }

        // ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testDirectConnection(serviceName, endpoint) {
            log(`ğŸ”— ${serviceName} ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`);
            
            // ì„œë¹„ìŠ¤ë³„ ì§ì ‘ í¬íŠ¸ ë§¤í•‘
            const servicePortMap = {
                'USER-SERVICE': 8081,
                'BE-APIManagementService': 8082,
                'BE-CustomAPIManagementService': 8083,
                'BE-AIFeatureService': 8084,
                'BE-SystemManagementService': 8085
            };
            
            const port = servicePortMap[serviceName];
            if (!port) {
                log(`âŒ ${serviceName}ì˜ í¬íŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`, 'error');
                return;
            }
            
            try {
                const directUrl = `http://localhost:${port}${endpoint}`;
                log(`ğŸ”— ì§ì ‘ ì—°ê²°: ${directUrl}`);
                
                const response = await fetch(directUrl);
                const responseText = await response.text();
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch {
                    responseData = responseText;
                }
                
                if (response.ok) {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="success">âœ… ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!<br>
                        <strong>ìƒíƒœ ì½”ë“œ:</strong> ${response.status}<br>
                        <strong>ì‘ë‹µ:</strong><br>
                        <pre>${JSON.stringify(responseData, null, 2)}</pre><br>
                        <em>ğŸ’¡ ì„œë¹„ìŠ¤ëŠ” ì •ìƒì´ì§€ë§Œ API Gateway ë¼ìš°íŒ…ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.</em></div>`;
                    log(`âœ… ${serviceName} ì§ì ‘ ì—°ê²° ì„±ê³µ (í¬íŠ¸ ${port})`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
            } catch (error) {
                document.getElementById('api-result').innerHTML = 
                    `<div class="error">âŒ ì§ì ‘ ì—°ê²°ë„ ì‹¤íŒ¨<br>
                    <strong>ì˜¤ë¥˜:</strong> ${error.message}<br>
                    <em>ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì™„ì „íˆ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></div>`;
                log(`âŒ ${serviceName} ì§ì ‘ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ
        function loadTestScenarios() {
            log('ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤...');
            
            const scenarios = [
                { name: 'ì‚¬ìš©ì ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬', service: 'USER-SERVICE', endpoint: '/actuator/health', method: 'GET' },
                { name: 'API ê´€ë¦¬ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬', service: 'BE-APIManagementService', endpoint: '/actuator/health', method: 'GET' },
                { name: 'ì»¤ìŠ¤í…€ API ê´€ë¦¬ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬', service: 'BE-CustomAPIManagementService', endpoint: '/actuator/health', method: 'GET' },
                { name: 'AI ê¸°ëŠ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬', service: 'BE-AIFeatureService', endpoint: '/actuator/health', method: 'GET' },
                { name: 'ì‹œìŠ¤í…œ ê´€ë¦¬ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬', service: 'BE-SystemManagementService', endpoint: '/actuator/health', method: 'GET' }
            ];

            let resultHtml = '<h4>ğŸ§ª ìë™ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰</h4>';
            resultHtml += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
            
            scenarios.forEach((scenario, index) => {
                resultHtml += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #667eea;">
                        <strong>${scenario.name}</strong><br>
                        <small>${scenario.method} ${scenario.endpoint}</small><br>
                        <button class="btn" onclick="runScenario('${scenario.service}', '${scenario.endpoint}', '${scenario.method}')" style="margin-top: 5px; padding: 5px 10px; font-size: 0.9em;">ì‹¤í–‰</button>
                    </div>
                `;
            });
            
            resultHtml += '</div>';
            document.getElementById('api-result').innerHTML = resultHtml;
            log('âœ… í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì™„ë£Œ');
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
        async function runScenario(service, endpoint, method) {
            document.getElementById('service-select').value = service;
            document.getElementById('api-endpoint').value = endpoint;
            document.getElementById('http-method').value = method;
            
            await testMicroservice();
        }

        // ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜
        async function simulateFailure() {
            log('ğŸ’¥ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
            
            try {
                // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œë¡œ ì‹¤íŒ¨ ìœ ë„
                const response = await fetch('http://localhost:8080/gateway/users/simulate-failure', {
                    credentials: 'include'
                });
                
                log('ğŸ“Š ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ. ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                
                // ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ ë‹¤ì‹œ í™•ì¸
                setTimeout(() => {
                    checkCircuitBreakers();
                }, 2000);
                
            } catch (error) {
                log('ğŸ’¥ ì˜ë„ëœ ì‹¤íŒ¨ ë°œìƒ: ' + error.message, 'error');
            }
        }

        // MSA í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘
        function startMSATest() {
            log('ğŸš€ MSA í†µí•© í…ŒìŠ¤íŠ¸ ì‹œí€€ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!');
            log('1ï¸âƒ£ ìœ ë ˆì¹´ ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í™•ì¸ ì™„ë£Œ');
            log('2ï¸âƒ£ API Gateway ìƒíƒœ í™•ì¸ ì™„ë£Œ');
            log('3ï¸âƒ£ Auth0 ì¸ì¦ì„ ì§„í–‰í•´ì£¼ì„¸ìš”');
            log('4ï¸âƒ£ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ API í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”');
            log('5ï¸âƒ£ ì„œí‚· ë¸Œë ˆì´ì»¤ ëª¨ë‹ˆí„°ë§ì„ í™•ì¸í•´ì£¼ì„¸ìš”');
        }

        // ìœ ë ˆì¹´ UI ì—´ê¸°
        function openEurekaUI() {
            window.open('http://localhost:8761', '_blank');
            log('ğŸŒ ìœ ë ˆì¹´ ì„œë²„ UIê°€ ìƒˆ íƒ­ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤.');
        }
    </script>
</body>
</html>